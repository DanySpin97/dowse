FILE=$(shell find './src' -type f -name '*.c' )
INCLUDEOPTS=$(shell awk -F'=' -f ./tool/extract_include.awk conf/build.conf |tr -d '\n' )
INCLUDEOPTS+=-I./src
INCLUDEOPTS+=-I/usr/include
WEBUI_PROTOTYPE_H=src/webui_prototype.h
TMP=src/.tmp_file

#--- Keep in mind . When the dowse building is executed the webui.conf.dist file is copied adding some parameter ...
#--- so you _CANT_ use "make all" after "make debug" but you need to execute ./compile.sh webui from ../src parent directory.

all: cproto asset
	rm -f assets/*~
#	cp -f conf/webui.conf.dist conf/webui.conf
	../kore/kodev/kodev flavor prod
	../kore/kodev/kodev build

echo:
	@echo ${INCLUDEOPTS}

cproto:
	touch src/assets.h ;
	echo "" > ${WEBUI_PROTOTYPE_H}
	echo "/* Automatically generated by : make cproto */" > ${TMP}
	cproto ${FILE} ${INCLUDEOPTS} >>  ${TMP}
	/bin/mv -f ${TMP} ${WEBUI_PROTOTYPE_H}

run:
	../kore/kodev/kodev run

asset src/assetmap.c:
	@echo "Creating assetmap.c" ; ./map_assets > src/assetmap.c

build:
	../kore/kodev/kodev build

debug: cproto src/assetmap.c
	rm -f assets/*~
	cp -f conf/webui-debug.conf.dist conf/webui.conf
	../kore/kodev/kodev flavor dev
	../kore/kodev/kodev build
##	./webui -r -n -f

clean:
	rm -f webui
	../kore/kodev/kodev clean

