#!/bin/sh
#
# This file contains general variables used among the project.

dowse_sysconfdir=/etc/dowse
dowse_install_dir=/opt/dowse
dowse_working_dir=/var/lib/dowse
dowse_livedir=/var/run/dowse
dowse_logdir=/var/log/dowse
dowse_daemons=${dowse_install_dir}/daemons
dowse_daemons_conf=${dowse_daemons}/conf
dowse_generated_conf=${dowse_livedir}/conf

. ${dowse_sysconfdir}/settings

# cover defaults
interface=${interface:-lo}
hostname=${hostname:-`hostname`}
address=${address:-127.0.0.1}
wan=${wan:-""}
dns=${dns:-127.0.0.1}
dowse_uid=${dowse_uid:-dowse}
dowse_gid=${dowse_gid:-dowse}
dowse_net=${dowse_net:-127.0.0.0/24}
netmask=${netmask:-255.255.255.0}
dowse_guests=${dowse_guests:-10.0.0.101,10.0.0.199,48h}
lan=${lan:-dowse.it}

firewall=${firewall:-yes}

net_devices=""
devices=$(find /sys/devices/ -name net)
for i in $devices; do
	for dev in $(ls --indicator-style=none $i); do
		# skip the loopback device
		[ "$dev" = "lo" ] && continue
		net_devices="$net_devices $dev"
	done
done
for interface in $net_devices; do
	_addr=`ip addr show $interface | awk '/inet / {print $2}'`
	[ "$_addr" = "" ] && continue
	range=${_addr#*/}
	address=${_addr%/*}

	wan=`ip route show dev $interface | awk '/default/ {print $3}'`
	[ "$wan" = "" ] && continue

	# render the dowse_net
	if [ $range = 24 ]; then
		subn=${wan%\.*}
		dowse_net=$subn.0/24
		netmask=255.255.255.0
		dowse_guests=$subn.101,$subn.199,48h
	elif [ $range = 16 ]; then
		subn=${wan%\.*\.*}
		dowse_net=$subn.0.0/16
		netmask=255.255.0.0
		dowse_guests=$subn.0.101,$subn.255.199,48h
	elif [ $range = 8 ]; then
		subn=${wan%%\.*}
		dowse_net=$subn.0.0.0/8
		netmask=255.0.0.0
		dowse_guests=$subn.0.0.101,$subn.255.255.199,48h
	fi
done

